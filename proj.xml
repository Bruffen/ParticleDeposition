<?xml version="1.0" ?>
<project name="Particle Deposition" width = "1280" height = "720">
	<assets>
		<constants>
			<constant name="TEXTURE_RESOLUTION" value="1024" />
			<constant name="NUMBER_OF_PARTICLES" value="100000" />
		</constants>
        <attributes>
			<attribute name="radius" data="FLOAT" type="RENDERER" value=100 />
			<attribute name="gravity" data="FLOAT" type="RENDERER" value=9.8 />
			<attribute name="speed" data="FLOAT" type="RENDERER" value=3.228 />
			<attribute name="width" data="FLOAT" type="RENDERER" value=0.01 />
			<attribute name="height" data="FLOAT" type="RENDERER" value=0.04 />
			<attribute name="particleSize" data="FLOAT" type="RENDERER" value=0.1 />
			<attribute name="minHeight" data="FLOAT" type="RENDERER" value=0.002 />
			<attribute name="viscosity" data="FLOAT" type="RENDERER" value=0.009 />
			<attribute name="windDir" data="VEC3" type="RENDERER" x=15 y=15 z=-10/>
			<attribute name="particleAlpha" data="FLOAT" type="RENDERER" value=0.75 />
			<attribute name="particleColor" data="VEC3" type="RENDERER" x=0.3 y=0.7 z=0.9 />
			<attribute name="marchingStep" data="FLOAT" type="RENDERER" value=0.008 />
			<attribute name="marchingMax" data="INT" type="RENDERER" value=750 />
			<attribute name="particlesActive" data="INT" type="RENDERER" value=1 />
			<attribute name="simulIterations" data="INT" type="RENDERER" value=1 />
			<attribute name="offsetX" data="FLOAT" type="RENDERER" value=0/>
			<attribute name="offsetY" data="FLOAT" type="RENDERER" value=0/>
			<attribute name="setupDone" data="INT" type="RENDERER" value=0/>
			<attribute name="step" data="INT" type="RENDERER" value=0/>
			<attribute name="height1" data="FLOAT" type="RENDERER" value=7.5/>
			<attribute name="height2" data="FLOAT" type="RENDERER" value=5/>
			<attribute name="height3" data="FLOAT" type="RENDERER" value=2.5/>
        </attributes>
		<scenes>
			<scene name="scene1">
				<file name="models/scene1.obj"/>
			</scene>
			<scene name="car">
				<file name="models/lamborghini_aventador.obj"/>
				<SCALE x=0.02 y=0.02 z=0.02 />
			</scene>
			<scene name="camoes">
				<file name="models/LargoCamoes/largoCamoes.nbo"/>
			</scene>
			<scene name="Plane">
				<geometry name = "square" type = "SQUARE" />
				<SCALE x=10 y=1 z=10 />
			</scene>
			<scene name="Sphere">
				<geometry name = "sphere" type = "SPHERE" />
				<TRANSLATE x=5 y=0 z=0 />
				<SCALE x=1 y=1 z=1 />
			</scene>
			<scene name="Particles" >
				<buffers name="Positions" primitive="POINTS" material=ParticlesBB>
					<position name="Positions" fromLibrary="particleLib" />	
					<!-- <position name="Positions" fromLibrary="particleLib" />			 -->
				</buffers>	
			</scene>
		</scenes>
		
		<viewports>
			<viewport name="MainViewport">
				<CLEAR_COLOR r="0.8" g="1.0" b="0.7" />
			</viewport>
			<viewport name="HeightViewport">
				<CLEAR_COLOR r="0.8" g="1.0" b="0.7" />
			</viewport>
			<viewport name="Right" >
				<ORIGIN x = 0.5 y =0 />
				<SIZE width=0.5 height=1 />
				<CLEAR_COLOR  r="1.0" g="1.0" b="1.0" />
			</viewport>
		</viewports>
		
		<cameras>
			<camera name="HeightCamera" >
				<TYPE 	value="ORTHO" />
				<RIGHT 	value=10 />
				<LEFT 	value=-10 />
				<TOP 	value=10 />
				<BOTTOM value=-10 />
				<NEAR	value=0.0001/>
				<FAR	value=10 />
				<viewport name="MainViewport" />
				<POSITION x=0.0 y=10.0 z=0.0 />
				<VIEW 	x=0.0 y=-1.0 z=0.0 />
				<UP 	x=0.0 y=0.0 z=1.0 />
			</camera>
			<camera name="HeightCamera1" >
				<TYPE 	value="ORTHO" />
				<RIGHT 	value=10 />
				<LEFT 	value=-10 />
				<TOP 	value=10 />
				<BOTTOM value=-10 />
				<NEAR	value=0.0001/>
				<FAR	value=10 />
				<viewport name="MainViewport" />
				<POSITION x=0.0 y=10.0 z=0.0 />
				<VIEW 	x=0.0 y=-1.0 z=0.0 />
				<UP 	x=0.0 y=0.0 z=1.0 />
			</camera>
			<camera name="HeightCamera2" >
				<TYPE 	value="ORTHO" />
				<RIGHT 	value=10 />
				<LEFT 	value=-10 />
				<TOP 	value=10 />
				<BOTTOM value=-10 />
				<NEAR	value=0.0001/>
				<FAR	value=10 />
				<viewport name="MainViewport" />
				<POSITION x=0.0 y=10.0 z=0.0 />
				<VIEW 	x=0.0 y=-1.0 z=0.0 />
				<UP 	x=0.0 y=0.0 z=1.0 />
			</camera>
			<camera name="HeightCamera3" >
				<TYPE 	value="ORTHO" />
				<RIGHT 	value=10 />
				<LEFT 	value=-10 />
				<TOP 	value=10 />
				<BOTTOM value=-10 />
				<NEAR	value=0.0001/>
				<FAR	value=10 />
				<viewport name="MainViewport" />
				<POSITION x=0.0 y=10.0 z=0.0 />
				<VIEW 	x=0.0 y=-1.0 z=0.0 />
				<UP 	x=0.0 y=0.0 z=1.0 />
			</camera>
			<camera name="HeightCamera4" >
				<TYPE 	value="ORTHO" />
				<RIGHT 	value=10 />
				<LEFT 	value=-10 />
				<TOP 	value=10 />
				<BOTTOM value=-10 />
				<NEAR	value=0.0001/>
				<FAR	value=10 />
				<viewport name="MainViewport" />
				<POSITION x=0.0 y=10.0 z=0.0 />
				<VIEW 	x=0.0 y=-1.0 z=0.0 />
				<UP 	x=0.0 y=0.0 z=1.0 />
			</camera>
			<camera name="HeightCameraBot" >
				<TYPE 	value="ORTHO" />
				<RIGHT 	value=10 />
				<LEFT 	value=-10 />
				<TOP 	value=10 />
				<BOTTOM value=-10 />
				<NEAR	value=0.0001/>
				<FAR	value=10 />
				<viewport name="MainViewport" />
				<POSITION x=0.0 y=0.0 z=0.0 />
				<VIEW 	x=0.0 y=1.0 z=0.0 />
				<UP 	x=0.0 y=0.0 z=1.0 />
			</camera>
			<camera name="HeightCameraBot2" >
				<TYPE 	value="ORTHO" />
				<RIGHT 	value=10 />
				<LEFT 	value=-10 />
				<TOP 	value=10 />
				<BOTTOM value=-10 />
				<NEAR	value=0.0001/>
				<FAR	value=10 />
				<viewport name="MainViewport" />
				<POSITION x=0.0 y=0.0 z=0.0 />
				<VIEW 	x=0.0 y=1.0 z=0.0 />
				<UP 	x=0.0 y=0.0 z=1.0 />
			</camera>
			<camera name="HeightCameraBot3" >
				<TYPE 	value="ORTHO" />
				<RIGHT 	value=10 />
				<LEFT 	value=-10 />
				<TOP 	value=10 />
				<BOTTOM value=-10 />
				<NEAR	value=0.0001/>
				<FAR	value=10 />
				<viewport name="MainViewport" />
				<POSITION x=0.0 y=0.0 z=0.0 />
				<VIEW 	x=0.0 y=1.0 z=0.0 />
				<UP 	x=0.0 y=0.0 z=1.0 />
			</camera>
			<camera name="HeightCameraBot4" >
				<TYPE 	value="ORTHO" />
				<RIGHT 	value=10 />
				<LEFT 	value=-10 />
				<TOP 	value=10 />
				<BOTTOM value=-10 />
				<NEAR	value=0.0001/>
				<FAR	value=10 />
				<viewport name="MainViewport" />
				<POSITION x=0.0 y=0.0 z=0.0 />
				<VIEW 	x=0.0 y=1.0 z=0.0 />
				<UP 	x=0.0 y=0.0 z=1.0 />
			</camera>
			<camera name="MainCamera" >
				<viewport name="MainViewport" />
				<POSITION x=0.0 y=1.0 z=5.0 />
				<NEAR 	value=0.1 />
				<FAR 	value=1000 /> 
			</camera>
			
		</cameras>
		
		<lights>
			<light name="Sun">
				<DIRECTION x="1" y="-1" z="-1" />
			</light>
		</lights>

        <materialLibs>
			<materialLib filename="proj.mlib" />
		</materialLibs>
	</assets>
	
	<pipelines>
			<!-- Set the orthographic cameras properties -->
			<!--preScript script="adapt" file="scripts/cameraAdapt.lua" /-->
		<pipeline name="setup">
			<testScript script="slice" file="scripts/depthSplitter.lua" TEST_MODE="RUN_WHILE" />
			<!-- Render the scene from above for height info -->
			<pass class="default" name="heightMapSetup">
		    <pass class="default" name="heightMapSetup1">
				<scenes>
					<!--
					<scene name="scene1" /> 
					<scene name="camoes" /> 
					/-->
					<scene name="car" /> 
					<scene name="Plane" />
					<scene name="Sphere" />
				</scenes>
				<camera name="HeightCamera1" />
                <renderTarget name="HeightMap" fromLibrary="particleLib" />
			</pass>
		    <pass class="default" name="heightMapSetup2">
				<scenes>
					<!--
					<scene name="scene1" /> 
					<scene name="camoes" /> 
					/-->
					<scene name="car" /> 
					<scene name="Plane" />
					<scene name="Sphere" />
				</scenes>
				<camera name="HeightCamera2" />
                <renderTarget name="HeightMap2" fromLibrary="particleLib" />
			</pass>
		    <pass class="default" name="heightMapSetup3">
				<scenes>
					<!--
					<scene name="scene1" /> 
					<scene name="camoes" /> 
					/-->
					<scene name="car" /> 
					<scene name="Plane" />
					<scene name="Sphere" />
				</scenes>
				<camera name="HeightCamera3" />
                <renderTarget name="HeightMap3" fromLibrary="particleLib" />
			</pass>
		    <pass class="default" name="heightMapSetup4">
				<scenes>
					<!--
					<scene name="scene1" /> 
					<scene name="camoes" /> 
					/-->
					<scene name="car" /> 
					<scene name="Plane" />
					<scene name="Sphere" />
				</scenes>
				<camera name="HeightCamera4" />
                <renderTarget name="HeightMap4" fromLibrary="particleLib" />
			</pass>
		    <pass class="default" name="heightMapBotSetup">
				<scenes>
					<!--
					<scene name="scene1" /> 
					<scene name="camoes" /> 
					/-->
					<scene name="car" /> 
					<scene name="Plane" />
					<scene name="Sphere" />
				</scenes>
				<camera name="HeightCameraBot" />
                <renderTarget name="HeightMapBot" fromLibrary="particleLib" />
			</pass>
		    <pass class="default" name="heightMapBotSetup2">
				<scenes>
					<!--
					<scene name="scene1" /> 
					<scene name="camoes" /> 
					/-->
					<scene name="car" /> 
					<scene name="Plane" />
					<scene name="Sphere" />
				</scenes>
				<camera name="HeightCameraBot2" />
                <renderTarget name="HeightMapBot2" fromLibrary="particleLib" />
			</pass>
		    <pass class="default" name="heightMapBotSetup3">
				<scenes>
					<!--
					<scene name="scene1" /> 
					<scene name="camoes" /> 
					/-->
					<scene name="car" /> 
					<scene name="Plane" />
					<scene name="Sphere" />
				</scenes>
				<camera name="HeightCameraBot3" />
                <renderTarget name="HeightMapBot3" fromLibrary="particleLib" />
			</pass>
		    <pass class="default" name="heightMapBotSetup4">
				<scenes>
					<!--
					<scene name="scene1" /> 
					<scene name="camoes" /> 
					/-->
					<scene name="car" /> 
					<scene name="Plane" />
					<scene name="Sphere" />
				</scenes>
				<camera name="HeightCameraBot4" />
                <renderTarget name="HeightMapBot4" fromLibrary="particleLib" />
			</pass>
			<pass class="compute" name="slice">
				<material name="slice" fromLibrary="particleLib" dimX="TEXTURE_RESOLUTION" dimY="TEXTURE_RESOLUTION" dimZ=1 />
			</pass>
			<pass class="quad" name="activateCamera">
                <camera name="MainCamera" />
				<viewport name="MainViewport" />
			</pass>
		</pipeline>
		<pipeline name="pip" >
			<!-- Compute all the particles in a compute shader -->
			<pass class="compute" name="particles">
				<material name="matParticles" fromLibrary="particleLib" dimX="NUMBER_OF_PARTICLES" dimY=1 dimZ=1 />
			</pass>
			<!-- Compute the deposition of particles -->

			<pass class="compute" name="deposition">
				<material name="depositionHeight" fromLibrary="particleLib" dimX="TEXTURE_RESOLUTION" dimY="TEXTURE_RESOLUTION" dimZ=1 />
			</pass>
			<pass class="default" name="depthMapSetup">
				<scenes>
					<scene name="car" /> 
					<scene name="Plane" />
					<scene name="Sphere" />
				</scenes>
				<camera name="MainCamera" />
				<materialMaps>
					<map fromMaterial="*" toMaterial="DepthMap" toLibrary="particleLib"/>
				</materialMaps>
                <renderTarget name="Depth" fromLibrary="particleLib" />

			</pass>

			<!--pass class="compute" name="addVect">
				<material name="depositionHeight" fromLibrary="particleLib" dimX=1024 dimY=1024 dimZ=1 />
			</pass-->
			<!-- Render the scene from normal camera -->
			<pass class="default" name="sceneRender">
				<scenes>
					<!--
					<scene name="scene1" /> 
					<scene name="camoes" /> 
					/-->
					<scene name="car" /> 
					<scene name="Plane" />
					<scene name="Sphere" />
					<scene name ="Particles" />
				</scenes>
				<camera name="MainCamera" />
				<lights>
					<light name="Sun" />
				</lights>
				<materialMaps>
					<map fromMaterial="ParticlesBB" toMaterial="ParticlesBB" toLibrary="particleLib" />
				</materialMaps>
				<renderTarget name="Render" fromLibrary="particleLib" />
			</pass>

			<!-- Render the volume from particles on top of the rendered scene -->
 			<pass class="quad" name="volumeRender">
                <camera name="MainCamera" />
				<viewport name="MainViewport" />
				<materialMaps>
					<map fromMaterial="__Quad" toMaterial="matRenderVolume" toLibrary="particleLib"/>
				</materialMaps>
			</pass>

		</pipeline>
	</pipelines>

    <interface> 
		<window label="Particles">
			<var label="Radius" type="RENDERER" context="CURRENT" component="radius" 
				def="min=1 max=150 step=0.01"/>
			<var label="Gravity" type="RENDERER" context="CURRENT" component="gravity" 
				def="min=0.00 max=2000 step=0.01"/>
			<var label="Speed" type="RENDERER" context="CURRENT" component="speed" 
				def="min=0.01 max=5 step=0.01"/>
			<var label="Width" type="RENDERER" context="CURRENT" component="width" 
				def="min=0.01 max=10 step=0.01"/>
			<var label="Height" type="RENDERER" context="CURRENT" component="height" 
				def="min=0.01 max=10 step=0.01"/>
			<var label="Particle Size" type="RENDERER" context="CURRENT" component="particleSize" 
				def="min=0.01 max=5 step=0.01"/>
			<var label="Wind Direction" type="RENDERER" context="CURRENT" component="windDir" />	
			<var label="Particles Active" type="RENDERER" context="CURRENT" component="particlesActive" 
				def="min=0 max=1 step=1"/>
		</window>
		<window label="Particle Simulation">
			<var label="Rugosidade" type="RENDERER" context="CURRENT" component="minHeight" 
				def="min=0.0 max=0.01 step=0.001"/>
			<var label="Viscosity" type="RENDERER" context="CURRENT" component="viscosity" 
				def="min=0.0 max=1 step=0.01"/>
			<var label="Iters per Sim step" type="RENDERER" context="CURRENT" component="simulIterations" 
				def="min=1 max=10 step=1"/>
		</window>
		<window label="Rendering">
			<var label="Particle Color" type="RENDERER" context="CURRENT" component="particleColor" 
				def="min=0 max=1 step=0.01"/>
			<var label="Particle Alpha" type="RENDERER" context="CURRENT" component="particleAlpha" 
				def="min=0 max=1 step=0.01"/>
			<var label="Marching Step" type="RENDERER" context="CURRENT" component="marchingStep" 
				def="min=0.001 max=1 step=0.001"/>
			<var label="Marching Max" type="RENDERER" context="CURRENT" component="marchingMax" />
			<var label="OffsetX" type="RENDERER" context="CURRENT" component="offsetX" def="step=0.00001" min="-0.0001" max="0.0001" />
			<var label="OffsetY" type="RENDERER" context="CURRENT" component="offsetY" def="step=0.00001" min="-0.0001" max="0.0001"/>
		</window>
    </interface> 
</project>